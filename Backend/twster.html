<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“š ORTBooks - Pedir Libro</title>

  <!-- SoqueTIC -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.8.1/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/JZylber/SoqueTIC-Client@v1.4.2/soquetic-client.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: #eef2f5;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      color: #007bff;
      margin-bottom: 20px;
    }

    .datos-comprador {
      width: 320px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 25px;
    }

    .datos-comprador input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .card {
      width: 260px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      padding: 12px;
      text-align: center;
      position: relative;
      transition: 0.2s;
      margin-bottom: 15px;
    }

    .card:hover { transform: scale(1.02); }

    .card img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      background-color: #ddd;
    }

    .titulo { font-weight: bold; margin: 8px 0 4px; font-size: 17px; }
    .precio { color: #111; font-weight: 700; margin-bottom: 4px; }
    .publicado, .aula { font-size: 14px; color: #333; margin-bottom: 8px; }

    .btn-pedir {
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 20px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .btn-pedir:hover { background-color: #0056b3; }

    .mensaje {
      margin-top: 10px;
      font-size: 14px;
      padding: 6px;
      border-radius: 6px;
      display: none;
    }
    .ok { background-color: #d4edda; color: #155724; }
    .error { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

  <h2>ðŸ“– Libros disponibles</h2>

  <!-- Datos del comprador -->
  <div class="datos-comprador">
    <h3>Tus datos</h3>
    <input type="text" id="nombreComprador" placeholder="Tu nombre completo">
    <input type="email" id="mailComprador" placeholder="Tu email ORT">
  </div>

  <!-- Contenedor donde aparecerÃ¡n los libros -->
  <div id="contenedorLibros"></div>

  <script>
    emailjs.init("mVxAIaYu2qV-k6IqG");
    connect2Server(3000);

    const contenedor = document.getElementById("contenedorLibros");

    // 1ï¸âƒ£ Cargar los libros desde Libros.json
    fetch("Libros.json")
      .then(res => res.json())
      .then(libros => mostrarLibros(libros))
      .catch(err => console.error("Error al leer Libros.json:", err));

    function mostrarLibros(libros) {
      libros.forEach(libro => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <img src="${libro.foto || 'https://via.placeholder.com/200x160?text=Libro'}" alt="Libro">
          <div class="titulo">${libro.libro}</div>
          <div class="precio">$${libro.precio}</div>
          <div class="publicado">Publicado por <b>${libro.nombreVendedor}</b></div>
          <div class="aula">Aula: ${libro.sede || "Sin especificar"}</div>
          <button class="btn-pedir">PEDIR</button>
          <div class="mensaje" id="msg-${libro.libro.replace(/\s+/g, '')}"></div>
        `;

        const btn = div.querySelector(".btn-pedir");
        const msg = div.querySelector(".mensaje");
        btn.addEventListener("click", () => pedirLibro(libro, msg, btn));

        contenedor.appendChild(div);
      });
    }

    // 2ï¸âƒ£ Cuando el usuario pide un libro
    function pedirLibro(libro, msg, btn) {
      const nombreComprador = document.getElementById("nombreComprador").value.trim();
      const mailComprador = document.getElementById("mailComprador").value.trim();

      if (!nombreComprador || !mailComprador) {
        mostrarMensaje(msg, "âš ï¸ CompletÃ¡ tus datos antes de pedir", "error");
        return;
      }

      btn.textContent = "Enviando...";
      msg.style.display = "none";

      // Consultar al backend quiÃ©n es el vendedor
      postEvent("pedirLibro", { tituloLibro: libro.libro }, (res) => {
        if (res.error) {
          mostrarMensaje(msg, res.error, "error");
          btn.textContent = "PEDIR";
          return;
        }

        // Enviar el correo
        emailjs.send("service_17ffctj", "template_punaxpk", {
          nombreVendedor: res.vendedor.nombre,
          nombreComprador: nombreComprador,
          tituloLibro: libro.libro,
          mailComprador: mailComprador,
          email: res.vendedor.mail
        })
        .then(() => {
          mostrarMensaje(msg, "ðŸ“¨ Pedido enviado correctamente al vendedor", "ok");
          btn.textContent = "PEDIR";
        })
        .catch((err) => {
          console.error(err);
          mostrarMensaje(msg, "âŒ Error al enviar correo", "error");
          btn.textContent = "PEDIR";
        });
      });
    }

    function mostrarMensaje(msg, texto, tipo) {
      msg.textContent = texto;
      msg.className = `mensaje ${tipo}`;
      msg.style.display = "block";
      setTimeout(() => (msg.style.display = "none"), 4000);
    }
  </script>
</body>
</html>
